---
title: 虚拟存储
date: 2018-5-6 09:12:42
tags: 存储
categories: 系统学习

---
首先介绍一下本节的核心知识点：

1. 虚拟存储的需求背景
2. 覆盖技术
3. 交换技术
4. 局部性原理
5. 虚拟存储概念
6. 虚拟页式存储
7. 缺页异常
<!--more-->
## 1.虚拟存储的需求背景

需求的原因：因为一些大量的并发线程或者进程的运行,计算机系统时常出现内存空间不够用，所以最终诞生了虚拟存储的这中技术需求

内存不够用的一些解决办法：

1.覆盖：应用程序手动的把需要的指令和数据保存在内存中

2.交换：操作系统自动把暂时不能执行的程序保存到外存中

3.虚拟内存：在有限的容量内存中，以页为单位自动装入更多更大的程序。

## 2.覆盖和交换技术
### 覆盖技术
目标：在较小的可用内存中运行较大的程序

实现方法：依据程序的逻辑结构（这里我的理解就是各个函数直接的结构钢关系），将程序划分为若干功能相对独立的模块，将不会同时执行的模块共享一块存储区域（这里的意思就是没有调用关系的函数模块可以共享一块存储区域）

在这里要注意这么几点：

1.必要部分（常用功能）的代码和数据常驻内存中

2.可选部分（不常用的功能）放在其它程序的模块中，只在需要的时候装入到内存中

3.不存在 相互调用关系的模块可以相互覆盖，共同用一块内存区域，只不过他们之间需要换来换去。

下面用图示说明问题：

![](https://i.imgur.com/sTkzPAF.jpg)

将不存在调用关系的模块分成一组，选取每组中占用内存最大的分配内存，然后根据调用关系去换出换入就可以了！

覆盖技术的缺点：

1增加了编程的难度

程序员需要自己去合理设计每个函数之间的调用关系

2.增加了执行的时间

频繁从外存装入内存的覆盖区域中。

这是一种时间换去空间的做法。

### 交换技术



- 目标：是针对有很多应用程序运行的时候，内存空间不够用了，而不是像覆盖技术那样，一个应用程序运行内存空间都不够用。
- 实现：将当前暂时不能运行的程序放到外存，这里要注意的是，换入换出的基本单位是整个进程的地址空间放入外存或者放回内存
- 交换技术面临的问题：
  
  1.交换时机：只有当内存空间不够或者可能不够的时候换出
  
  2.交换区的大小：存放用户空间所有内存映像的拷贝
  
  3.程序换入时的重定向：采用动态地址映射

下面对于交换和覆盖进行比较：

覆盖：

1.只能发生在 没有调用的模块关系间

2.程序员要给出模块的覆盖关系

3.发生在运行的程序的内部模块之间

交换：

1.以进程为单位

2.不需要模块之间的逻辑覆盖结构

3.发生在内存进程间

## 3.局部性原理

- 概念：程序在执行过程中的一个较短的时间，所执行的指令地址和指令操作数地址，分别局限于一定的区域。

时间局部性：一条指令的一次执行和下次执行，一个数据的一次访问和下次访问都是集中在一个较短的时期内

空间局部性：当前指令和邻近的几条指令，当前访问的数据和邻近的几个数据都集中在一个较小的区域内

分支局部性：一条跳转指令的两次执行，很可能跳到相同的内存位置

![](https://i.imgur.com/hKUo5fS.jpg)

## 4.虚拟存储的概念

思路：将不常用的部分内存块暂时放到外存中

原理：装在程序的时候只是将当前执行需要的部分页面或者段装入内存，在执行执行的过程中需要的指令或者数据不在内存的时候（成为缺页），处理器通知操作系统将相应的页面或者段调入内存中去，当然还需要操作系统维护内存将暂时不用的页面或者段保存到外存中去。

实现方式：基于之前的非连续存储方式中的段式存储和页式存储，所以这里也分为虚拟段式和虚拟页式存储。

虚拟存储的特点 ：

1.物理内存和虚拟内存都可以不连续

2.大用户空间，提供给用户的虚拟内存大于实际内存。

3.部分交换技术，虚拟存储只对部分虚拟地址空间进行调入和调出

虚拟存储的技术支持：

1.硬件：页式或短时存储中的地址映射转换机制（MMU）

2.操作系统：管理内存和外存间的页面或者段的换出换入

## 5.虚拟页式存储管理

概念：就是在非连续存储页式存储的 基础上，加上请求调页和页面置换

思路：

1.当用户程序要装在到内存运行时候，只装入部分页面，就启动运行程序

2.进程在运行中发现有需要的代码或者数据不在内存中时，则向系统发出缺页异常请求

3.操作系统在处理缺页异常的时候，将外存的相应页面调入内存，使得程序能继续执行

## 6.缺页异常
![](https://i.imgur.com/9hrdNhT.jpg)